# LightTrack GUI 跟踪问题修复文档

## 问题描述

用户报告了GUI跟踪器的问题：
1. ✅ 选择视频 - 正常
2. ✅ 框选目标（瓶子）- 正常  
3. ✅ 开始跟踪 - 正常
4. ❌ **但是跟踪结果错误** - 边界框一直显示在左上角，而不是跟踪用户选择的目标

## 根本原因分析

通过详细调查，发现问题的根本原因是：

1. **当真实LightTrack模型可用时**（非演示模式），如果跟踪器返回无效坐标（如`target_pos=[0, 0]`）
2. **坐标转换过程**：`bbox = [0-30, 0-30, 60, 60] = [-30, -30, 60, 60]`
3. **边界限制**：负坐标被限制为 `[-30, -30, 60, 60] → [0, 0, 60, 60]`
4. **最终结果**：边界框出现在左上角而不是用户选择的位置

## 解决方案

在 `gui_tracker.py` 的 `_track_video()` 方法中实现了以下修复：

### 1. 添加坐标验证

```python
# 提取坐标值
center_x = self._safe_extract_coordinate(target_pos, 0)
center_y = self._safe_extract_coordinate(target_pos, 1)
size_w = self._safe_extract_coordinate(target_sz, 0)
size_h = self._safe_extract_coordinate(target_sz, 1)

# 验证跟踪结果是否合理
if (center_x <= 0 or center_y <= 0 or 
    size_w <= 0 or size_h <= 0 or
    center_x >= width or center_y >= height or
    size_w > width or size_h > height):
    
    self.log(f"检测到无效的跟踪结果: center=({center_x:.1f}, {center_y:.1f}), size=({size_w:.1f}, {size_h:.1f})")
    raise ValueError("跟踪结果无效")
```

### 2. 验证的条件

修复检查以下无效情况：
- ❌ 零或负数的中心位置 (`center_x <= 0`, `center_y <= 0`)
- ❌ 超出边界的位置 (`center_x >= width`, `center_y >= height`)  
- ❌ 零或负数的尺寸 (`size_w <= 0`, `size_h <= 0`)
- ❌ 过大的边界框 (`size_w > width`, `size_h > height`)

### 3. 优雅的错误处理

当检测到无效结果时：
1. 📝 记录无效结果到日志
2. 🔄 切换跟踪器到演示模式  
3. 🎯 **保持当前边界框位置**（不跳转到左上角）
4. ⚠️ 防止左上角问题

### 4. 改进的回退逻辑

```python
except Exception as e:
    self.log(f"跟踪出错，回退到演示模式: {e}")
    self.model = None
    state = None
    
    # 保持当前bbox位置，不要应用随机漂移（避免跳动）
    # 只有在后续帧中才开始演示跟踪
    if frame_idx > 1:
        drift_x = np.random.normal(0, 2)
        drift_y = np.random.normal(0, 2)
        # ... 应用漂移
```

## 测试结果

### ✅ 修复前的问题场景

```
用户选择: [390, 210, 60, 60] (瓶子位置)
跟踪器返回: target_pos=[0, 0], target_sz=[60, 60]
转换结果: bbox = [-30, -30, 60, 60]
边界限制后: bbox = [0, 0, 60, 60] ← 左上角！
```

### ✅ 修复后的正确行为

```
用户选择: [390, 210, 60, 60] (瓶子位置)
跟踪器返回: target_pos=[0, 0], target_sz=[60, 60] 
验证结果: 检测到无效坐标！
修复处理: 保持位置 [390, 210, 60, 60] ← 正确位置！
回退模式: 切换到演示模式继续跟踪
```

## 兼容性

- ✅ **现有功能不受影响**：命令行演示仍正常工作
- ✅ **演示模式不受影响**：当没有真实模型时正常工作
- ✅ **正常跟踪不受影响**：当跟踪器返回有效坐标时正常工作
- ✅ **线程安全不受影响**：GUI线程安全机制保持不变

## 使用方法

修复后的使用方法：

1. 运行：`python gui_tracker.py`
2. 选择视频文件
3. 框选目标（瓶子）
4. 开始跟踪
5. **结果**：边界框现在会正确跟踪选择的目标，而不是跳转到左上角！

## 技术细节

修复的关键改进：

1. **预防性验证**：在坐标转换前验证跟踪器结果
2. **边界感知**：检查坐标是否在视频帧范围内
3. **优雅降级**：无效结果时切换到演示模式而不是崩溃
4. **位置保持**：保持用户选择的位置而不是重置到原点
5. **详细日志**：提供无效结果的详细信息便于调试

这个修复解决了用户报告的核心问题，确保跟踪边界框始终停留在用户选择的目标位置附近，而不是意外跳转到屏幕的左上角。