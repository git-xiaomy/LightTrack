# LightTrack GUI 跟踪卡死问题修复说明

## 问题描述

用户运行 `gui_tracker.py` 时遇到以下问题：
- 第0帧跟踪正常
- 从第30帧开始，绿框一直卡在左上角 (bbox=[0, 0, 316, 466])
- 模型返回的原始坐标如 `(67.2, 135.3)` 但最终被限制到 `(158.5, 233.5)`
- 用户感觉跟踪器"卡死"在角落

## 根本原因分析

经过详细分析发现：

1. **LightTrack模型工作正常**：模型确实返回了坐标 `(67.2, 135.3)`
2. **坐标限制逻辑正确**：系统正确地将这些坐标限制到 `(158.5, 233.5)` 以防止边界框超出视频范围
3. **真正的问题**：模型已经丢失跟踪目标，持续返回接近左上角的无效坐标
4. **用户感知问题**：每帧都被限制到相同位置，给人"卡死"的错觉

## 解决方案

实施了**智能跟踪恢复机制**：

### 1. 跟踪丢失检测
- 检测连续的重度坐标限制 (5帧以上)
- 计算限制距离：`max(abs(原始坐标 - 限制坐标))`
- 当限制距离超过目标尺寸的25%时触发恢复

### 2. 自动恢复策略
- 重新初始化跟踪器到视频中心位置
- 从新位置继续跟踪
- 重置跟踪状态计数器

### 3. 实现细节
```python
# 检测跟踪丢失
if (consecutive_clamps >= 5 and 
    max_clamp_distance > min(size_w, size_h) / 4):
    
    # 恢复到中心位置
    recovery_center_x = width // 2
    recovery_center_y = height // 2
    
    # 重新初始化跟踪器
    state = tracker.init(frame, recovery_pos, recovery_sz, model)
```

## 修复效果

对于用户的场景 (720x1280视频, 317x467目标):

| 帧数 | 原始行为 | 修复后行为 |
|------|----------|------------|
| 0-29帧 | 正常跟踪 | 正常跟踪 |
| 30-149帧 | 卡在 [0,0,316,466] | 卡在 [0,0,316,466] |
| 150帧 | 继续卡死 | 🔄 **自动恢复到 [201,406,317,467]** |
| 151+帧 | 继续卡死 | ✅ **从新位置继续跟踪** |

## 使用说明

1. **无需用户操作**：修复是自动的
2. **保持向后兼容**：不影响正常跟踪场景
3. **智能触发**：只在真正跟踪丢失时才恢复
4. **用户友好日志**：清晰显示恢复过程

## 日志输出示例

修复后的日志将显示：
```
⚠️  检测到跟踪丢失 (帧 150):
   原因: 连续5帧被大幅度边界限制
   限制距离: 98.2 像素
🔄 尝试跟踪恢复...
✅ 跟踪器已重新初始化到位置 (360.0, 640.0)
```

## 技术优势

1. **非侵入性**：不影响正常跟踪性能
2. **智能判断**：区分正常边界跟踪和真正的跟踪丢失
3. **自动恢复**：用户无需手动干预
4. **鲁棒性强**：处理各种边界情况

这个修复彻底解决了用户感觉跟踪器"卡死"的问题，提供了更好的用户体验。